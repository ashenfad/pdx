<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet">
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="stylesheet" type="text/css" href="pdx.css">
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.css'
          rel='stylesheet' />
    <link rel="stylesheet" href="nouislider.css">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.js'></script>
    <script src='range.js'></script>
    <script src='sort.js'></script>
    <script src='within.js'></script>
    <script src='kdbush.js'></script>
    <script src='bitset.js'></script>
    <script src='papaparse.min.js'></script>
    <script src='ingest.js'></script>
    <script src='nouislider.min.js'></script>
    <script src='wNumb.js'></script>
    <script src='jquery-2.2.4.min.js'></script>
    <script src='jquery.query-object.js'></script>

    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>
    <div id='map'></div>
    <div id="alert">
        Initializing map...
    </div>
    <div id='sidebar'>
        <div id='filters'>
            <div class="selector">
                <fieldset class="filter-group filter-group-top">
                    <legend>Building Details</legend>
                    <div class="filter-group-member filter-group-member-top">
                        <div class="slide-line">
                            <i class="material-icons" title="Home Type">home</i>
                            <div class="filter-select">
                                <select id="home-type">
                                    <option value="all" selected="selected">All homes</option>
                                    <option value="single">Single family</option>
                                    <option value="multi">Multi-familty</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group-member">
                        <div class="slide-line">
                            <i class="material-icons" title="Year Built">date_range</i>
                            <label id="year-min" class="slide-val slide-val-left">-</label>
                            <div class="slide-wrapper">
                                <div id="year-slider" class="slider" />
                            </div>
                        </div>
                        <label id="year-max" class="slide-val slide-val-right">-</label>
                    </div>
                </fieldset>

                <fieldset class="filter-group">
                    <legend>Minutes to Downtown</legend>
                    <div class="filter-group-member filter-group-member-top">
                        <div class="slide-line">
                            <i class="material-icons" title="Downtown Destination">location_city</i>
                            <div class="filter-select">
                                <select id="downtown-type">
                                    <option value="union">Union Station</option>
                                    <option value="pioneer" selected="selected">Pioneer Square</option>
                                    <option value="psu">PSU Urban Center</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group-member">
                        <div class="slide-line">
                            <i class="material-icons" title="Transit Time">directions_bus</i>
                            <label id="downtown-transit-min" class="slide-val slide-val-left">-</label>
                            <div class="slide-wrapper">
                                <div id="downtown-transit-slider" class="slider" />
                            </div>
                        </div>
                        <label id="downtown-transit-max" class="slide-val slide-val-right">-</label>
                    </div>

                    <div class="filter-group-member">
                        <div class="slide-line">
                            <i class="material-icons" title="Cycling Time">directions_bike</i>
                            <label id="downtown-cycling-min" class="slide-val slide-val-left">-</label>
                            <div class="slide-wrapper">
                                <div id="downtown-cycling-slider" class="slider" />
                            </div>
                        </div>
                        <label id="downtown-cycling-max" class="slide-val slide-val-right">-</label>
                    </div>
                </fieldset>

                <fieldset class="filter-group">
                    <legend>Minutes to Nearest Grocery</legend>
                    <div class="filter-group-member filter-group-member-top">
                        <div class="slide-line">
                            <i class="material-icons" title="Grocery Type">local_grocery_store</i>
                            <div class="filter-select">
                                <select id="grocery-type">
                                    <option value="any" selected="selected">Any grocery store</option>
                                    <option value="chain">Only large chains</option>
                                    <option value="indie">Only independent or ethnic</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group-member">
                        <div class="slide-line">
                            <i class="material-icons" title="Walking Time">directions_walk</i>
                            <label id="grocery-walking-min" class="slide-val slide-val-left">-</label>
                            <div class="slide-wrapper">
                                <div id="grocery-walking-slider" class="slider" />
                            </div>
                        </div>
                        <label id="grocery-walking-max" class="slide-val slide-val-right">-</label>
                    </div>

                    <div class="filter-group-member">
                        <div class="slide-line">
                            <i class="material-icons" title="Cycling Time">directions_bike</i>
                            <label id="grocery-cycling-min" class="slide-val slide-val-left">-</label>
                            <div class="slide-wrapper">
                                <div id="grocery-cycling-slider" class="slider" />
                            </div>
                        </div>
                        <label id="grocery-cycling-max" class="slide-val slide-val-right">-</label>
                    </div>
                </fieldset>

                <fieldset class="filter-group filter-group-bottom">
                    <legend>Minutes to Neighborhood School</legend>
                    <div class="filter-group-member filter-group-member-top">
                        <div class="slide-line">
                            <i class="material-icons" title="School Type">school</i>
                            <div class="filter-select">
                                <select id="school-type">
                                    <option value="elementary" selected="selected">Elementary</option>
                                    <option value="middle">Middle School</option>
                                    <option value="high">High School</option>
                                    <option value="all">All levels</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group-member">
                        <div class="slide-line">
                            <i class="material-icons" title="Walking Time">directions_walk</i>
                            <label id="school-walking-min" class="slide-val slide-val-left">-</label>
                            <div class="slide-wrapper">
                                <div id="school-walking-slider" class="slider" />
                            </div>
                        </div>
                        <label id="school-walking-max" class="slide-val slide-val-right">-</label>
                    </div>

                    <div class="filter-group-member">
                        <div class="slide-line">
                            <i class="material-icons" title="Cycling Time">directions_bike</i>
                            <label id="school-cycling-min" class="slide-val slide-val-left">-</label>
                            <div class="slide-wrapper">
                                <div id="school-cycling-slider" class="slider" />
                            </div>
                        </div>
                        <label id="school-cycling-max" class="slide-val slide-val-right">-</label>
                    </div>
                </fieldset>

            </div>
        </div>
        <div id='info' hidden="true">
            <div id="addresstext"></div>
        </div>
    </div>

    <script>

     var ccolor = '#ffa';
     var clusterRadius = 1;
     var pointRadius = 2;
     var blur = 1;

     mapboxgl.accessToken = 'pk.eyJ1IjoiYXNoZW5mYWQiLCJhIjoiY2lvMzY4Y3NqMWFzdXVhbTM0b2x6dHgwZiJ9.NIaE79-ogfd1lOiyAr6tUw';

     function updateProgress(rowCount) {
         /* console.log('ADAM - rowcount:', rowCount); */
     }

     var map;
     var data;
     var arrays;

     var lats;
     var longs;
     var years;
     var homeTypes;
     var downtownTransit;
     var downtownCycling;
     var groceryWalking;
     var groceryCycling;

     function setPair(param, vals) {
         setParam(param, vals[0] + "-" + vals[1]);
     }

     function getSetPair(param, dflt) {
         var vs = getParam(param);
         if (vs == "") {
             vs = dflt;
         } else {
             vs = vs.split("-");
             vs[0] = Number(vs[0]);
             vs[1] = Number(vs[1]);
         }
         setPair(param, vs);
         return vs;
     }

     function getSet(param, dflt, num) {
         var v = getParam(param);
         if (v == "") {
             v = dflt;
         }
         if (num) {
             v = Number(v);
         }
         setParam(param, v);
         return v;
     }

     var currentYear;
     var globalYear = [1880, 2015];

     var currentDowntownTransit;
     var currentDowntownCycling;
     var globalTransit = [1, 90];
     var globalCycling = [1, 70];

     var currentGroceryWalking;
     var currentGroceryCycling;
     var globalGroceryWalking = [1, 60];
     var globalGroceryCycling = [1, 20];

     var currentSchoolWalking;
     var currentSchoolCycling;
     var globalSchoolWalking = [1, 140];
     var globalSchoolCycling = [1, 50];

     var selectedDest;
     var selectedHomeType;
     var selectedGrocery;
     var selectedSchool;

     var kd;
     var kdpts;
     var visible;

     var infoDiv = document.getElementById('info');
     var alertDiv = document.getElementById('alert');

     function makeSlider(id, param, overallRange, currentRange) {
         var minId = id + '-min';
         var maxId = id + '-max';
         document.getElementById(minId).innerHTML = currentRange[0];
         document.getElementById(maxId).innerHTML = currentRange[1];
         var slider = document.getElementById(id + '-slider');
         noUiSlider.create(slider, {
	     start: currentRange,
             step: 1,
             connect: true,
             behaviour: 'drag',
	     range: {
	         'min': overallRange[0],
	         'max': overallRange[1]
	     }
         });
         slider.noUiSlider.on('slide', function(){
             var range = slider.noUiSlider.get();
             document.getElementById(minId).innerHTML = parseInt(range[0]);
             document.getElementById(maxId).innerHTML = parseInt(range[1]);
         });
         slider.noUiSlider.on('set', function(){
             var range = slider.noUiSlider.get();
             /* currentRange = range; */
             currentRange[0] = range[0];
             currentRange[1] = range[1];
             setParam(param, Math.round(range[0]) + "-" + Math.round(range[1]));
             updateForSlider();
         });

         return slider;
     }

     function initControls() {
         currentYear = getSetPair("y", globalYear);
         currentDowntownTransit = getSetPair("dt", globalTransit);
         currentDowntownCycling = getSetPair("dc", globalCycling);
         currentGroceryWalking = getSetPair("gw", globalGroceryWalking);
         currentGroceryCycling = getSetPair("gc", globalGroceryCycling);
         currentSchoolWalking = getSetPair("sw", globalSchoolWalking);
         currentSchoolCycling = getSetPair("sc", globalSchoolCycling);

         selectedDest = getSet("dest", "pioneer", false);
         selectedHomeType = getSet("home", "all", false);
         selectedGrocery = getSet("grocery", "any", false);
         selectedSchool = getSet("school", "elementary", false);

         var groceryType = document.getElementById('grocery-type');
         groceryType.value = selectedGrocery;
         groceryType.addEventListener("change", function (sel) {
             selectedGrocery = groceryType.options[groceryType.selectedIndex].value;
             setParam("grocery", selectedGrocery);
             updateForSlider();
         });

         var schoolType = document.getElementById('school-type');
         schoolType.value = selectedSchool;
         schoolType.addEventListener("change", function (sel) {
             selectedSchool = schoolType.options[schoolType.selectedIndex].value;
             setParam("school", selectedSchool);
             updateForSlider();
         });

         var downtownType = document.getElementById('downtown-type');
         downtownType.value = selectedDest;
         downtownType.addEventListener("change", function (sel) {
             selectedDest = downtownType.options[downtownType.selectedIndex].value;
             setParam("dest", selectedDest);
             updateForSlider();
         });

         var homeType = document.getElementById('home-type');
         homeType.value = selectedHomeType;
         homeType.addEventListener("change", function (sel) {
             selectedHomeType = homeType.options[homeType.selectedIndex].value;
             setParam("home", selectedHomeType);
             updateForSlider();
         });

         makeSlider('year', 'y', globalYear, currentYear);
         makeSlider('downtown-transit', 'dt', globalTransit, currentDowntownTransit);
         makeSlider('downtown-cycling', 'dc', globalCycling, currentDowntownCycling);
         makeSlider('grocery-walking', 'gw', globalGroceryWalking, currentGroceryWalking);
         makeSlider('grocery-cycling', 'gc', globalGroceryCycling, currentGroceryCycling);
         makeSlider('school-walking', 'sw', globalSchoolWalking, currentSchoolWalking);
         makeSlider('school-cycling', 'sc', globalSchoolCycling, currentSchoolCycling);
     }

     function inRange(range, val) {
         return (val >= range[0] && val <= range[1]);
     }

     function updateForSlider() {
         var ids = [];
         var homeType = -1;
         if (selectedHomeType == "single") {
             homeType = 0;
         } else if (selectedHomeType == "multi") {
             homeType = 1;
         }

         if (selectedDest == "pioneer") {
             downtownTransit = arrays[7];
             downtownCycling = arrays[10];
         } else if (selectedDest == "union") {
             downtownTransit = arrays[8];
             downtownCycling = arrays[11];
         } else if (selectedDest == "psu") {
             downtownTransit = arrays[9];
             downtownCycling = arrays[12];
         }

         for (var i = 0; i < years.length; i++) {
             var gWalking;
             var gCycling;
             if (selectedGrocery == "indie") {
                 gWalking = groceryWalkingIndie[i];
                 gCycling = groceryCyclingIndie[i];
             } else if (selectedGrocery == "chain") {
                 gWalking = groceryWalkingChain[i];
                 gCycling = groceryCyclingChain[i];
             } else {
                 gWalking = Math.min(groceryWalkingIndie[i], groceryWalkingChain[i]);
                 gCycling = Math.min(groceryCyclingIndie[i], groceryCyclingChain[i]);
             }

             var sWalkingMin;
             var sWalkingMax;
             var sCyclingMin;
             var sCyclingMax;
             if (selectedSchool == "elementary") {
                 sWalkingMax = elementaryWalking[i];
                 sCyclingMax = elementaryCycling[i];
                 sWalkingMin = sWalkingMax;
                 sCyclingMin = sCyclingMax;
             } else if (selectedSchool == "middle") {
                 sWalkingMax = middleWalking[i];
                 sCyclingMax = middleCycling[i];
                 sWalkingMin = sWalkingMax;
                 sCyclingMin = sCyclingMax;
             } else if (selectedSchool == "high") {
                 sWalkingMax = highWalking[i];
                 sCyclingMax = highCycling[i];
                 sWalkingMin = sWalkingMax;
                 sCyclingMin = sCyclingMax;
             } else {
                 sWalkingMax = Math.max(elementaryWalking[i], middleWalking[i], highWalking[i]);
                 sCyclingMax = Math.max(elementaryCycling[i], middleCycling[i], highCycling[i]);
                 sWalkingMin = Math.min(elementaryWalking[i], middleWalking[i], highWalking[i]);
                 sCyclingMin = Math.min(elementaryCycling[i], middleCycling[i], highCycling[i]);
             }

             if ((homeType == -1 || homeType == homeTypes[i])
                 && inRange(currentYear, years[i])
                 && inRange(currentDowntownTransit, downtownTransit[i])
                 && downtownCycling[i] > 0
                 && inRange(currentDowntownCycling, downtownCycling[i] + 2)
                 && inRange(currentGroceryWalking, gWalking)
                 && gCycling > 0
                 && inRange(currentGroceryCycling, gCycling + 2)
                 && inRange(currentSchoolWalking, sWalkingMin)
                 && inRange(currentSchoolWalking, sWalkingMax)
                 && sCyclingMin > 0
                 && inRange(currentSchoolCycling, sCyclingMin + 2)
                 && inRange(currentSchoolCycling, sCyclingMax + 2))
             {
                 ids.push(i);
             }
         }
         refreshData(ids);
     }

     var addressText = document.getElementById('addresstext');

     function resetMissing(arr, val) {
         for (i in arr) {
             if (arr[i] == -1) {
                 arr[i] = val;
             }
         }
         return arr;
     }

     function initialize(fields, initArrays) {
         arrays = initArrays;

         longs = arrays[0];
         lats = arrays[1];
         address = arrays[2];
         homeTypes = arrays[3];

         years = arrays[6];
         downtownTransit = resetMissing(arrays[7], 9999);
         downtownCycling = resetMissing(arrays[10], 9999);

         groceryWalkingChain = resetMissing(arrays[14], 9999);
         groceryCyclingChain = resetMissing(arrays[15], 9999);
         groceryWalkingIndie = resetMissing(arrays[17], 9999);
         groceryCyclingIndie = resetMissing(arrays[18], 9999);

         highWalking = resetMissing(arrays[20], 9999);
         highCycling = resetMissing(arrays[21], 9999);

         middleWalking = resetMissing(arrays[23], 9999);
         middleCycling = resetMissing(arrays[24], 9999);

         elementaryWalking = resetMissing(arrays[26], 9999);
         elementaryCycling = resetMissing(arrays[27], 9999);

         initControls();
         makeMap();
     }

     function makeFeature(id) {
         return {type: 'Feature',
                 geometry: {type: 'Point',
                            coordinates: [longs[id], lats[id]]},
                 properties: {year: years[id]}};
     }

     function makeFeatures(ids) {
         var features = [];
         for (i in ids) {
             features.push(makeFeature(ids[i]));
         }
         return {type: 'FeatureCollection',
                 features: features};
     }

     function rangeArr(val) {
         return Array.from(new Array(val),
                           function (x, i) {return i;});
     }

     function refreshData(ids) {
         visible = new BitSet();
         for (var i = 0; i < ids.length; i++) {
             visible.set(ids[i]);
         }
         var features = makeFeatures(ids);
         /* console.log("alert on");
            alertDiv.hidden = false; */
         data.setData(features);
     }

     function lngX(lng) {
         return lng / 360 + 0.5;
     }
     function latY(lat) {
         var sin = Math.sin(lat * Math.PI / 180),
             y = (0.5 - 0.25 * Math.log((1 + sin) / (1 - sin)) / Math.PI);
         return y < 0 ? 0 :
                y > 1 ? 1 : y;
     }

     function initData() {
         data = new mapboxgl.GeoJSONSource(
             {data: [],
              cluster: true,
              clusterMaxZoom: 14,
              clusterRadius: clusterRadius});

         updateForSlider();

         kdpts = [];
         for (var i = 0; i < lats.length; i++) {
             kdpts.push([lngX(longs[i]), latY(lats[i])]);
         }
         kd = kdbush(kdpts);

         map.addSource('pointSource', data);
         map.addLayer({
             id: 'pointLayer',
             type: 'circle',
             source: 'pointSource',
             paint: {
                 'circle-color': ccolor,
                 'circle-radius': {
                     stops: [[14, 2], [18, 6]]
                 },
                 'circle-blur': blur}
         });
     }

     function sqrDist(x, y, i) {
         var pt = kdpts[i];
         var xDiff = x - pt[0];
         var yDiff = y - pt[1];
         return (xDiff * xDiff) + (yDiff * yDiff);
     }

     function makeMap() {
         var lng = getSet("lng", -122.5976);
         var lat = getSet("lat", 45.5235);
         var z = getSet("z", 11.54);

         map = new mapboxgl.Map({
             container: 'map', // container id
             style: 'mapbox://styles/ashenfad/cio37ctbg0037aenfc0q91jxc',
             center: [lng, lat],
             zoom: z
         });

         map.getCanvas().style.cursor = "default";

         map.on("load", function() {
             console.log("alert off");
             alertDiv.hidden = true;

             map.on('mousemove', function (e) {
                 var coord = map.unproject([e.point.x, e.point.y]);
                 var searchR = 25 / (512 * Math.pow(2, map.getZoom()));
                 var x = lngX(coord.lng);
                 var y = latY(coord.lat);
                 var candidates = kd.within(x, y, searchR);
                 var visCandidates = [];
                 for (var i = 0; i < candidates.length; i++) {
                     if (visible.get(candidates[i])) {
                         visCandidates.push(candidates[i]);
                     }
                 }
                 candidates = visCandidates;

                 if (candidates.length > 0) {
                     var minCandidate;
                     var minVal = 999999;
                     for (var i = 0; i < candidates.length; i++) {
                         var candidate = candidates[i];
                         var dist = sqrDist(x, y, candidate);
                         if (dist < minVal) {
                             minVal = dist;
                             minCandidate = candidate;
                         }
                     }
                     addressText.innerHTML = address[minCandidate];
                     infoDiv.hidden = false;
                 } else {
                     addressText.innerHTML = "";
                     infoDiv.hidden = true;
                 }

             });
         });

         map.on("zoomend", function() {
             setParam("z", map.getZoom());
         });

         map.on("dragend", function() {
             var center = map.getCenter();
             setParam("lng", center.lng);
             setParam("lat", center.lat);
         });

         map.on('style.load', initData);
     }

     ingest('data.csv', true, initialize, updateProgress);


     function getParam(key) {
         return $.query.get(key);
     }

     function setParam(key, value) {
         var newQuery = $.query.SET(key, value).toString();
         window.history.replaceState({}, "", window.location.href.split('?')[0] + newQuery);
     }

    </script>

    <script type="text/javascript">
     var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
     document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>

    <script type="text/javascript">
     try {
         var pageTracker = _gat._getTracker("UA-30723215-1");
         pageTracker._trackPageview();
     } catch(err) {}
    </script>

</body>
</html>
